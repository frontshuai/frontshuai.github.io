---
title: mysql学习笔记（四）
date: 2017-02-14 16:58:57
tags:
    - mysql
    - 查询优化
---
# mysql查询优化
mysql性能优化需要从查询优化、索引优化、库表结构优化着手。
这里主要是讨论查询优化
## 为什么查询速度会慢
在一个耗时的查询中，一般都会有一些不必要的额外操作、某些操作被额外的重复执行多次、某些操作执行的过慢等导致的。

## 慢查询基础：优化数据访问
查询性能低下的最基本的原因是访问的数据太多，所以大部分可以通过减少访问的数据量的方式优化。
对于低效的查询，通过以下两个步骤分析：
1. 确定应用程序是否在检索大量超过需要的数据。这通常意味着访问了太多的行或列。
2. 确定mysql服务器是否在分析大量超过需要的数据行。

### 是否想数据库请求了不需要的数据
有些查询会请求超过需要的数据，然后这些多余的数据会被应用程序丢弃。这会给mysql带来额外的f负担，并增加网络开销，另外也会消耗应用服务器的cpu和内存。

常见问题：
+ 查询不需要的记录：查询的时候查询过多的行，多余的行并无用。例如每次查询前10个记录的时候总是查出所有的结果。
+ 多表关联时返回全部列：在使用多表关联时只返回需要的字段，不要查询所有字段。
+ 总是取出全部列：不要每次select的时候总是使用 select * 返回所有列，只返回需要的字段。
+ 重复查询相同的数据：相同的数据总是重复的查询多次

### mysql是否在扫描额外的记录
在确认查询是否只返回需要数据以后，接下来应该看看查询为了返回结果是否扫描了过多的行。
衡量查询开销三个指标如下：
+ 响应时间
+ 扫描的行数
+ 返回的行数

## 重构查询方式
### 一个复杂的查询还是多个简单查询
设计查询的时候有时候总是想用一次查询查出最终结果，这样导致sql写的会比较麻烦，性能也会很差。所以有时候可以考虑把复杂的查询分成多次，这样请求端也可以做一部分处理等。

### 切分查询
一个大的返回结果的查询我们可以"分而治之"，每次查询一部分数据，分多次查询。
例如：查询10000条数据，但是数据量比较大，所以我们可以分为100次查询每次查询100条。

### 分解关联查询
有时候一个复杂的关联查询会占用mysql服务器大量的内存和cpu。所以可以把关联查询分开，逻辑处理在应用程序层进行一部分处理。
