---
title: 垃圾回收
tags:
  - 垃圾回收
categories: computer
date: 2017-05-31 16:25:09
---

# 垃圾回收
垃圾回收是对内存内不需要的对象销毁释放内存，避免内存泄漏导致程序崩溃

# 常用垃圾算法
## 引用计数法
引用计数（Reference Counting）算法是每个对象计算指向它的指针的数量，当有一个指针指向自己时计数值加1；当删除一个指向自己的指针时，计数值减1，如果计数值减为0，说明已经不存在指向该对象的指针了，所以它可以被安全的销毁了。

优点：在进行垃圾回收的时候无需挂起程序，常用在实时系统中。空间上的引用局部性比较好。某个对象的引用计数变为0后，系统无需访问位于堆中其他页面的单元。废弃即回收。
缺点：每次创建和销毁都要更新引用计数值，会引起额外的开销；引用计数占据了额外的空间；无法处理环形引用

python中使用的是引用计数算法。当对象的引用计数值为0时，将会调用__del__函数，至于为什么Python要选用引用计数算法，据我看过的一篇文章里面说，由于Python作为脚本语言，经常要与C/C++这些语言交互，而使用引用计数算法可以避免改变对象在内存中的位置，而Python为了解决环形引用问题，也引入gc模块，所以本质上Python的GC的方案是混合引用计数和跟踪（后面要讲的三个算法）两种垃圾回收机制。
## 标记清除法
这个方法是将垃圾回收分成了两个阶段：
标记阶段和清除阶段。

在标记阶段，通过跟对象，标记所有从跟节点开始的可达的对象，那么未标记的对象就是未被引用的垃圾对象。

在清除阶段，清除掉所以的未被标记的对象。

优点：相对于引用计数算法，减少了每次引用的加减计算
缺点：标记清楚必须暂停程序；便利所有的对象开销较大；垃圾回收后可能存在大量的内存碎片

## 标记压缩清除法
该方法在标记清楚的基础上添加了压缩过程，分为三个阶段：标记阶段，压缩阶段，清除阶段。标记阶段和清除阶段不变。

压缩阶段：在做完标记阶段后，将这些标记过的对象集中放到一起，确定开始和结束地址，比如全部放到开始处，这样再去清除，将不会产生磁盘碎片


优点：减少内存碎片
缺点：压缩阶段系统消耗，对象较多的时候开销太大

## 复制算法
将内存空间分成两块，同一时刻只使用其中的一块，在垃圾回收时将正在使用的内存中的存活的对象复制到未使用的内存中，然后清除正在使用的内存块中所有的对象，
然后把未使用的内存块变成正在使用的内存块，把原来使用的内存块变成未使用的内存块。

优点：但是这种方法也不会产生内存碎片
缺点：存活对象较多的话，算法效率会比较差；并且这样会使内存的空间折半

## 分代算法
主要思想是根据对象的生命周期长短特点将其进行分块，根据每块内存区间的特点，使用不同的回收算法，从而提高垃圾回收的效率。

java垃圾回收是对分代算法的应用。cms,G1回收
## 三色算法
三色标记法是标记清除的一个改进，它是一个并发的GC算法。

原理如下：

1. 首先创建三个集合：白、灰、黑。
2. 将所有对象放入白色集合中。
3. 然后从根节点开始遍历所有对象（注意这里并不递归遍历），把遍历到的对象从白色集合放入灰色集合。
4. 之后遍历灰色集合，将灰色对象引用的对象从白色集合放入灰色集合，之后将此灰色对象放入黑色集合
5. 重复 4 直到灰色中无任何对象
6. 收集所有白色对象（垃圾),检测对象有变化，重复以上操作